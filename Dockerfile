# syntax=docker/dockerfile:1.4        # включает расширенный синтаксис BuildKit

########################################################################
# БАЗОВЫЙ ОБРАЗ
########################################################################
FROM python:3.12-slim-bookworm

# ──────────────────────────────────────────────────────────────────────
# 1. Создаём системного пользователя, чтобы не запускать root-процесс
# ──────────────────────────────────────────────────────────────────────
RUN adduser --disabled-login --gecos "" app

########################################################################
# 2. Копируем исходники и устанавливаем зависимости
########################################################################
WORKDIR /app

# скопируем всё приложение целиком (Docker корректно кеширует слои)
COPY . .

# обновляем pip и ставим зависимости
RUN pip install --upgrade pip && \
    pip install .

########################################################################
# 3. Финальная конфигурация и команда запуска
########################################################################
USER app            # запускаем под непривилегированным пользователем
ENV PYTHONUNBUFFERED=1

# Railway подменит на ваш Start Command:
#   yfmcp --transport http --host 0.0.0.0 --port $PORT
# но запасной ENTRYPOINT лишним не будет
ENTRYPOINT ["yfmcp"]
